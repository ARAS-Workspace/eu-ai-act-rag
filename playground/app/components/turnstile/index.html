<!doctype html>
<!--
  SPDX-License-Identifier: MIT
  Copyright (C) 2026 Riza Emre ARAS

  Streamlit bi-directional component for Cloudflare Turnstile (Invisible mode).
  Self-configures by fetching site key from /api/config endpoint.
  Communicates with Python via the Streamlit Component postMessage protocol.
-->
<!--suppress JSUnresolvedReference, JSUnusedGlobalSymbols -->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Turnstile</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
      }
      #cf-turnstile {
        display: flex;
        justify-content: flex-start;
      }
    </style>
  </head>
  <body>
    <div id="cf-turnstile"></div>

    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit&onload=onTurnstileLoad"
      type="text/javascript"
    ></script>
    <script type="text/javascript">
      /** @type {typeof window & { turnstile: any, onTurnstileLoad: Function }} */
      (
        function () {
          "use strict";

          // ── Streamlit Component Protocol ──────────────────────────
          function sendMessage(
            /** @type {string} */ type,
            /** @type {object} */ data,
          ) {
            window.parent.postMessage(
              Object.assign({ isStreamlitMessage: true, type: type }, data),
              "*",
            );
          }

          function setComponentValue(/** @type {any} */ value) {
            sendMessage("streamlit:setComponentValue", { value: value });
          }

          function setFrameHeight(/** @type {number} */ height) {
            sendMessage("streamlit:setFrameHeight", { height: height });
          }

          function componentReady() {
            sendMessage("streamlit:componentReady", { apiVersion: 1 });
          }

          // ── Turnstile State ───────────────────────────────────────
          let widgetId = null;
          let lastResetCount = -1;
          let siteKey = null;
          let turnstileReady = false;
          let configFetched = false;

          // noinspection JSUnusedGlobalSymbols — called by Turnstile API onload param
          window.onTurnstileLoad = function () {
            turnstileReady = true;
            maybeRender();
          };

          // Fetch site key from Hono proxy config endpoint
          fetch("/api/config")
            .then(function (resp) {
              return resp.json();
            })
            .then(function (data) {
              siteKey = data.turnstileSiteKey || "";
              configFetched = true;
              if (!siteKey) {
                setFrameHeight(0);
                setComponentValue(null);
              } else {
                maybeRender();
              }
            })
            .catch(function () {
              configFetched = true;
              setFrameHeight(0);
              setComponentValue(null);
            });

          function maybeRender() {
            if (!turnstileReady || !configFetched || !siteKey) return;
            renderWidget();
          }

          function renderWidget() {
            const cf = /** @type {any} */ (window).turnstile;

            if (widgetId !== null) {
              cf.remove(widgetId);
              widgetId = null;
            }

            widgetId = cf.render("#cf-turnstile", {
              sitekey: siteKey,
              size: "invisible",
              callback: function (/** @type {string} */ token) {
                setComponentValue(token);
              },
              "expired-callback": function () {
                setComponentValue(null);
              },
              "error-callback": function () {
                setComponentValue(null);
              },
            });

            setFrameHeight(0);
          }

          // ── Listen for Streamlit Render Events ────────────────────
          window.addEventListener("message", function (event) {
            if (!event.data || event.data.type !== "streamlit:render") return;

            const args = event.data.args || {};
            const resetCount = args["reset_count"] || 0;

            if (resetCount !== lastResetCount) {
              lastResetCount = resetCount;
              if (widgetId !== null && siteKey) {
                /** @type {any} */ (window).turnstile.reset(widgetId);
              }
            }
          });

          componentReady();
        }
      )();
    </script>
  </body>
</html>
